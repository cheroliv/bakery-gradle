= Le Mystérieux Flash Blanc : Comprendre et Éliminer le FOUC de Thème
:author: Cheroliv
:email: cheroliv@cheroliv.com
:revdate: 2025-09-04
:revnumber: 1.0
:jbake-type: post
:jbake-status: published
:jbake-tags: webdev, javascript, css, bootstrap, FOUC, UX, a11y
:toc: left
:toclevels: 3
:sectnums:
:lang: fr
:summary: Découvrez pourquoi un flash blanc apparaît lors du changement de thème (clair/sombre) et apprenez à l'éradiquer avec une solution simple et efficace pour une expérience utilisateur parfaite.

Sur un site web moderne, l'une des fonctionnalités les plus appréciées est le sélecteur de thème (clair, sombre, contraste élevé). Cependant, lors de la navigation entre les pages, un détail agaçant peut survenir : un bref mais visible "flash" du thème par défaut avant que le thème choisi par l'utilisateur ne s'applique.

Cet article plonge au cœur de ce phénomène, souvent appelé **FOUC (Flash of Unstyled Content)** de thème, pour en expliquer la cause et, surtout, pour présenter une solution robuste qui garantit une transition parfaite.

== Le Symptôme : Un Flash de Lumière Inattendu

Le comportement est subtil mais déroutant. Lorsque je suis sur la page d'accueil de mon site et que je navigue entre les sections via le menu (`#about`, `#contact`), la transition est un défilement fluide, sans aucun flash.

En revanche, si je me trouve sur la page du blog et que je clique sur "Contact" dans le menu, l'écran flashe en blanc (le thème clair par défaut) pendant une fraction de seconde avant d'afficher la page d'accueil avec mon thème sombre sélectionné.

Pourquoi cette différence de comportement ?

*   **Navigation interne (sans flash) :** Sur une même page, les liens vers des ancres (`#contact`) sont gérés par JavaScript. Il n'y a pas de rechargement de page, juste un défilement.
*   **Navigation externe (avec flash) :** Passer de `/blog.html` à `/index.html#contact` force le navigateur à charger une toute nouvelle page. C'est durant ce processus de chargement que le flash se produit.

== Le Diagnostic : Une Course Contre la Montre

Le flash n'est pas un bug, mais le résultat logique de l'ordre dans lequel un navigateur traite une page web. C'est une véritable course entre le moteur de rendu et le moteur JavaScript.

Voici la séquence des événements qui crée le flash :

1.  **Chargement :** Le navigateur demande la nouvelle page (ex: `index.html`).
2.  **Rendu Initial :** Il commence à afficher le contenu dès qu'il le reçoit. Le CSS de base (Bootstrap) est appliqué, et le thème par défaut est le thème clair. **C'est ici que le flash blanc apparaît.**
3.  **Attente du JavaScript :** Le navigateur continue de lire le HTML et ne trouve la balise `<script>` de notre `ThemeManager` qu'à la toute fin du document, dans le pied de page.
4.  **Exécution du Script :** Le script s'exécute enfin. Il lit la préférence de l'utilisateur (ex: `"dark"`) dans le `localStorage` du navigateur.
5.  **Application du Thème :** Le script ajoute l'attribut `data-bs-theme="dark"` à la balise `<html>`.
6.  **Second Rendu :** Le navigateur réagit à ce changement d'attribut et redessine la page avec le thème sombre.

Le "flash" est donc le temps, très court, entre l'étape 2 et l'étape 6.

=== Diagramme du Problème

Pour visualiser ce processus, voici un diagramme de séquence :

[plantuml, target="fouc-theme-flash-before", format="svg"]
----
@startuml
participant Navigateur
participant DOM
participant "script.js (ThemeManager)" as Script

Navigateur->>DOM: Commence le rendu de la page
activate DOM
DOM-->>Navigateur: Affiche la page avec le thème par défaut (clair) -> **FLASH**
deactivate DOM

note right of Navigateur: Le rendu continue...

Navigateur->>Script: Exécute le script (chargé en fin de page)
activate Script
Script->>Script: Lit `localStorage.getItem('theme')`
Script->>DOM: Ajoute `data-bs-theme="dark"` sur `<html>`
activate DOM
DOM-->>Navigateur: Redessine la page avec le bon thème
deactivate DOM
deactivate Script
@enduml
----

== La Solution : Le Script Bouclier

Pour gagner cette course, nous devons informer le navigateur du thème à appliquer *avant* qu'il ne commence à dessiner le contenu principal de la page.

La solution consiste à placer un minuscule script JavaScript, dit "bloquant", directement dans la balise `<head>` du document HTML. Ce script a une seule mission : lire le `localStorage` et appliquer l'attribut `data-bs-theme` immédiatement.

Voici le code à insérer dans le template `header.thyme` :

[source,html]
----
<script th:inline="javascript">
  // IIFE (Immediately Invoked Function Expression) pour ne pas polluer l'espace global
  (function() {
    try {
      const theme = localStorage.getItem('theme');
      if (theme) {
        document.documentElement.setAttribute('data-bs-theme', theme);
      }
    } catch (e) {
      // La lecture du localStorage peut échouer en mode de navigation privée sur certains navigateurs
      console.warn('Could not set theme from localStorage', e);
    }
  })();
</script>
----

Pourquoi cette approche est-elle si efficace ?

*   **Exécution Immédiate :** Placé dans le `<head>`, ce script est l'une des premières choses que le navigateur exécute, bien avant de commencer le rendu du `<body>`.
*   **Bloquant :** Le navigateur attend la fin de l'exécution de ce script avant de continuer, garantissant que l'attribut `data-bs-theme` est en place au bon moment.
*   **Léger :** Le script est minuscule et son impact sur les performances est négligeable.

=== Diagramme de la Solution

Avec le script bouclier en place, la séquence devient beaucoup plus propre :

[plantuml, target="fouc-theme-flash-after", format="svg"]
----
@startuml
participant Navigateur
participant "Script Bouclier\n(inline <head>)" as Script
participant DOM

Navigateur ->> Script : Exécute le script inline dès sa lecture
activate Script
Script ->> Script : Lit `localStorage.getItem('theme')`
Script ->> DOM : Ajoute `data-bs-theme="dark"` sur `<html>`
deactivate Script

Navigateur ->> DOM : Commence le rendu de la page
activate DOM
DOM -->> Navigateur : Affiche la page directement avec le bon thème\n-> **PAS DE FLASH**
deactivate DOM
@enduml----

== Conclusion

Le "flash de thème" est un parfait exemple de la manière dont l'ordre d'exécution des ressources web impacte directement l'expérience utilisateur. En déplaçant la logique de sélection de thème dans un script bloquant et prioritaire, nous éliminons cette course et offrons une navigation fluide et professionnelle, digne d'une application moderne.

C'est un petit changement avec un impact majeur sur la perception de la qualité de votre site.
