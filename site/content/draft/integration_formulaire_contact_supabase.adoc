= Int√©gration d‚Äôun formulaire de contact avec Supabase et notifications Gmail
:author: √âquipe D√©veloppement
:description: Documentation pour l‚Äôint√©gration d‚Äôun formulaire de contact avec Supabase et notification e-mail via Google Apps Script
:jbake-type: page
:jbake-status: published
:jbake-tags: supabase, contact, gmail, apps-script, webhook
:icons: font
:toc: left
:toclevels: 3
:jbake-type: post
:jbake-title: Int√©gration d‚Äôun formulaire de contact avec Supabase et notifications Gmail via Google Apps Script
:jbake-tags: supabase, contact, formulaire, gmail, google-apps-script, int√©gration
:jbake-date: 2025-08-30
:jbake-author: cheroliv
:jbake-description: Tutoriel d√©taill√© sur l‚Äôint√©gration d‚Äôun formulaire de contact avec Supabase et l‚Äôenvoi de notifications par e-mail via Gmail en utilisant un hook Google Apps Script.


== Objectif

Ce document d√©crit l‚Äôint√©gration d‚Äôun formulaire de contact dans un site statique.
L‚Äôobjectif est double :

* Stocker les donn√©es des messages dans Supabase, table `contacts`.
* Notifier automatiquement l‚Äô√©quipe par e-mail via Gmail, en utilisant un hook Google Apps Script.

== Architecture g√©n√©rale

[plantuml, contact-sequence, svg]
----
@startuml
actor Utilisateur
participant "Site statique (HTML/JS)" as Site
participant "Supabase" as Supabase
participant "Trigger SQL" as Trigger
participant "Webhook Google Apps Script" as GAS
participant "Gmail" as Gmail

Utilisateur -> Site : Soumission du formulaire
Site -> Supabase : Insert contact (name, email, subject, message)
Supabase -> Trigger : D√©clenchement AFTER INSERT
Trigger -> GAS : Appel HTTP POST (donn√©es JSON)
GAS -> Gmail : Envoi email de notification
@enduml
----

== √âtapes d‚Äôint√©gration

=== 1. Pr√©parer le projet Supabase

. Cr√©er un projet dans https://supabase.com[Supabase].
. Ajouter une table `contacts` avec les colonnes suivantes :
* `id` ‚Üí UUID, `primary key`, `default: gen_random_uuid()`
* `name` ‚Üí `text`
* `email` ‚Üí `text`
* `subject` ‚Üí `text`
* `message` ‚Üí `text`
* `created_at` ‚Üí `timestamp`, `default: now()`

. Activer le RLS (Row Level Security).
. Cr√©er une policy d‚Äôinsertion publique :

[source,sql]
----
create policy "Allow insert for all"
on contacts
for insert
using (true);
----

=== 2. R√©cup√©rer les cl√©s d‚Äôacc√®s

Dans **Project Settings > API**, r√©cup√©rer :

* `SUPABASE_URL`
* `ANON_KEY` (cl√© publique utilisable c√¥t√© client)

Ces valeurs seront int√©gr√©es dans le code JS du site statique.

=== 3. Int√©grer Supabase dans le site statique

Ajouter le client Supabase dans le HTML, juste avant la fermeture du `</body>` :

[source,html]
----
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
----

=== 4. Pr√©parer le formulaire HTML

[source,html]
----
<form id="contact-form">
  <div class="row">
    <div class="col-md-6 mb-3">
      <input type="text" id="name" class="form-control" placeholder="Nom" required>
    </div>
    <div class="col-md-6 mb-3">
      <input type="email" id="email" class="form-control" placeholder="Email" required>
    </div>
  </div>
  <div class="mb-3">
    <input type="text" id="subject" class="form-control" placeholder="Sujet" required>
  </div>
  <div class="mb-3">
    <textarea id="message" class="form-control" rows="5" placeholder="Votre message" required></textarea>
  </div>
  <div class="text-center">
    <button type="submit" class="btn btn-primary btn-lg">
      <i class="bi bi-send me-2"></i>
      Envoyer le Message
    </button>
  </div>
</form>
<div id="form-status" class="text-center mt-3"></div>
----

=== 5. Connecter le formulaire √† Supabase

[source,html]
----
<script>
document.getElementById("contact-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const subject = document.getElementById("subject").value;
  const message = document.getElementById("message").value;

  const { data, error } = await supabase
    .from("contacts")
    .insert([{ name, email, subject, message }]);

  const status = document.getElementById("form-status");
  if (error) {
    status.innerHTML = `<span class="text-danger">‚ùå Erreur : ${error.message}</span>`;
  } else {
    status.innerHTML = `<span class="text-success">‚úÖ Message envoy√© avec succ√®s !</span>`;
    document.getElementById("contact-form").reset();
  }
});
</script>
----

=== 6. Cr√©er le hook Google Apps Script

. Acc√©der √† https://script.google.com et cr√©er un nouveau projet.
. Ajouter le script suivant :

[source,javascript]
----
// Fonction de webhook appel√©e par Supabase
function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);

    var name = data.record.name;
    var email = data.record.email;
    var subject = data.record.subject;
    var message = data.record.message;

    var recipient = "VOTRE_ADRESSE@gmail.com";
    var body = "Nouveau message re√ßu depuis le formulaire :\n\n"
      + "Nom: " + name + "\n"
      + "Email: " + email + "\n"
      + "Sujet: " + subject + "\n"
      + "Message:\n" + message;

    MailApp.sendEmail({
      to: recipient,
      subject: "üì© Nouveau contact : " + subject,
      body: body
    });

    return ContentService.createTextOutput(
      JSON.stringify({ status: "success" })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
----

. Publier le script :
**Deploy > New deployment > Web app**
* Ex√©cuter en tant que : **Me**
* Accessible par : **Anyone**
. R√©cup√©rer l‚ÄôURL du Web App d√©ploy√© (ex : `https://script.google.com/macros/s/XXXX/exec`).

=== 7. Ajouter une fonction et un trigger c√¥t√© Supabase

[source,sql]
----
-- 1. Activer l‚Äôextension pg_net
create extension if not exists pg_net;

-- 2. Cr√©er la fonction qui appelle le webhook Google Apps Script
create or replace function notify_gas()
returns trigger
language plpgsql
as $$
declare
  response json;
begin
  select net.http_post(
    url := 'https://script.google.com/macros/s/XXXX/exec', -- remplacer par votre URL
    headers := '{"Content-Type": "application/json"}',
    body := json_build_object('record', row_to_json(NEW))
  )
  into response;

  raise notice 'Webhook response: %', response;

  return NEW;
end;
$$;

-- 3. Cr√©er le trigger sur la table contacts
drop trigger if exists notify_gas_trigger on contacts;

create trigger notify_gas_trigger
after insert on contacts
for each row
execute function notify_gas();
----

== R√©sultat attendu

* Les donn√©es sont stock√©es dans Supabase (`contacts`).
* Chaque insertion d√©clenche un appel HTTP POST vers le webhook Apps Script.
* Gmail envoie un email automatique de notification.

== Prochaines √©tapes

* Ajouter une mise en forme HTML dans les e-mails envoy√©s.
* Mettre en place des validations renforc√©es (regex email, honeypot antispam).
* Journaliser les appels du webhook pour suivi et d√©bogage.
